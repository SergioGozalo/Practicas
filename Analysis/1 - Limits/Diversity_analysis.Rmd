---
title: "Diversity_analysis"
author: "Sergio Gozalo"
date: "5 de abril de 2021"
output: 
  github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = setwd("/Users/Usuario/Desktop/Bioinformatica/Practicas/Practicas/Analysis/"))
```

## Loading necessary libraries

```{r}
library("vegan")
library("ggplot2")
library("tidyr")
library("plyr")
library("dplyr")
library("reshape2")
library("randomcoloR")
```

```{r include=FALSE}
rarefaction<-function(x,subsample=1000, plot=TRUE, color=TRUE, error=FALSE, legend=TRUE, symbol){

        library(vegan)
        x <- as.matrix(x)
	y1<-apply(x, 1, sum)
        rare.data<-x                                   

        select<-unique(sort(c((apply(x, 1, sum)), (seq(0,(max(y1)), by=subsample)), recursive=TRUE)))
        storesummary.e<-matrix(data=NA, ncol=length(rare.data[,1]),nrow=length(select))
        rownames(storesummary.e)<-c(select)
        colnames(storesummary.e)<-rownames(x)
        storesummary.se<-matrix(data=NA, ncol=length(rare.data[,1]),nrow=length(select))
        rownames(storesummary.se)<-c(select)
        colnames(storesummary.se)<-rownames(x)

                for(i in 1:length(select))                      #the for loop
                        {
                        select.c<-select[i]                     #assigns the 'i'th element of select to select.c
                        foo<-rarefy(x,select.c, se=T)           #use whatever vegan fn you want
                storesummary.e[i,]<-foo[1,]
                storesummary.se[i,]<-foo[2,]            
                        }
                storesummary.e<-as.data.frame(storesummary.e)               
                richness.error<<-storesummary.se
                
for (i in 1:(length(storesummary.e)))
{
storesummary.e[,i]<-ifelse(select>sum(x[i,]), NA, storesummary.e[,i])
}

###############plot result################################
if (plot==TRUE)
 {
if(color==TRUE){
plot(select,storesummary.e[,1], xlab="Individuals in Subsample", 
xlim=c(0,max(select)), ylim=c(0, 5+(max(storesummary.e[,1:(length(storesummary.e))], na.rm=TRUE))),
ylab="Mean Species Richness", pch =16, col=2, type="n")

for (j in 1:(length(storesummary.e))){
points(select, storesummary.e[,j], pch=16, col=j+1, type="b", lty=1)}

if(error==TRUE){
for (m in 1:(length(storesummary.e))){
segments(select, storesummary.e[,m]+storesummary.se[,m],select, storesummary.e[,m]-storesummary.se[,m])
}
}
if (legend==TRUE){
legend("bottomright", colnames(storesummary.e), inset=0.05, lty=1, col=1:length(storesummary.e)+1, lwd=2)
}
}
else
{
plot(select,storesummary.e[,1], xlab="Individuals in Subsample", 
xlim=c(0,max(select)), ylim=c(0, 5+(max(storesummary.e[,1:(length(storesummary.e))], na.rm=TRUE))),
ylab="Mean Species Richness", pch =16, col=2, type="n")

for (j in 1:(length(storesummary.e))){
points(select, storesummary.e[,j], type="l", lty=1)}

for (k in 1:(length(storesummary.e))){
symbol<-ifelse(symbol<length(storesummary.e),rep(symbol,2),symbol)
points(as.numeric(rownames(subset(storesummary.e, storesummary.e[,k]==max(storesummary.e[,k],na.rm=TRUE)))), max(storesummary.e[,k],na.rm=TRUE), pch=symbol[k], cex=1.5)}

if(error==TRUE){
for (m in 1:(length(storesummary.e))){
points(select, storesummary.e[,m]+storesummary.se[,m], type="l", lty=2)
points(select, storesummary.e[,m]-storesummary.se[,m], type="l", lty=2)}}

k<-1:(length(storesummary.e))
if (legend==TRUE){
legend("bottomright", colnames(storesummary.e), pch=symbol[k], inset=0.05, cex=1.3)
}
}
}
print("rarefaction by J. Jacobs, last update April 17, 2009")
if(error==TRUE)(print("errors around lines are the se of the iterations, not true se of the means")  )     
list("richness"= storesummary.e, "SE"=richness.error, "subsample"=select)        
 
}
```

#Tables 

```{r}

f_kegg_scgt <- t(read.table("functional.tables/EMOSE-GC_ICM_250bp_KEGG.ko.lengthNorm.SCGnorm.counts.tbl", header = TRUE, sep = "\t", row.names = 1))

f_kegg_mgnt <- t(read.table("functional.tables/EMOSE-GC_ICM_250bp_KEGG.ko.lengthNorm.metaGsizeNorm.counts.tbl", header = TRUE, sep = "\t", row.names = 1))


icm_cog_scgt <- t(read.table("functional.tables/EMOSE-GC_ICM_250bp_COG.lengthNorm.SCGnorm.counts.tbl", header = TRUE, sep = "\t", row.names = 1))

icm_cog_mgnt <- t(read.table("functional.tables/EMOSE-GC_ICM_250bp_COG.lengthNorm.metaGsizeNorm.counts.tbl", header = TRUE, sep = "\t", row.names = 1))


icm_pfam_scgt <- t(read.table("functional.tables/EMOSE-GC_ICM_250bp_pfam.lengthNorm.SCGnorm.counts.tbl", header = TRUE, sep = "\t", row.names = 1))

icm_pfam_mgnt <- t(read.table("functional.tables/EMOSE-GC_ICM_250bp_pfam.lengthNorm.metaGsizeNorm.counts.tbl", header = TRUE, sep = "\t", row.names = 1))


otu_mitags <- (read.delim("functional.tables/otu_table97.txt", header = TRUE, sep = "\t"))
otu_mitags$OTUId <- NULL
otu_mitags <- t(otu_mitags)


```

## Richness MiTags

```{r}
otu_mitags_ss <- rrarefy(otu_mitags, min(rowSums(otu_mitags)))
richness <- estimateR(otu_mitags_ss)
richness
```

## Rarefaction MiTags

```{r}
otu_rare <- rarefaction(otu_mitags_ss)
```


## Rarecurve MiTags

```{r}
otu_rcurve <- rarecurve(otu_mitags_ss)
```

## Acumulation curve MiTags

```{r}
otu_acc <- specaccum(otu_mitags_ss, method = "exact", permutations = 1000)
plot(otu_acc)
```

## Accumulation curve KEGG SCG


### Whole

```{r}
kegg_acc1 <- specaccum(f_kegg_scgt, method = "exact", permutations = 1000)
plot(kegg_acc1)
```

### Subsampled

```{r}
f_kegt <- as.data.frame(f_kegg_scgt)
f_kegt[,1:6965] <- sapply(f_kegt[, c(1:6965)], as.integer)

kegg_ss <- rrarefy(f_kegt, min(rowSums(f_kegt)))
kegg_acc2 <- specaccum(kegg_ss, method = "exact", permutations = 1000)
plot(kegg_acc2)
```



## Accumulation curve KEGG MGN

### Whole

```{r}
kegg_acc1.1 <- specaccum(f_kegg_mgnt, method = "exact", permutations = 1000)
plot(kegg_acc1.1)
```



### Subsampled


```{r}
f_kegg_mgnt <- as.data.frame(f_kegg_mgnt)
f_kegg_mgnt[,1:6965] <- sapply(f_kegg_mgnt[, c(1:6965)], as.integer)
length(f_kegg_mgnt[,])
kegg_ss2 <- rrarefy(f_kegg_mgnt, min(rowSums(f_kegg_mgnt)))
kegg_acc2.2 <- specaccum(kegg_ss2, method = "exact", permutations = 1000)
plot(kegg_acc2.2)
```



## Accumulation curve COG SCG


### Whole

```{r}
cog_acc1 <- specaccum(icm_cog_scgt, method = "exact", permutations = 1000)
plot(cog_acc1)
```


### Subsampled


```{r}
icm_cog_scgt <- as.data.frame(icm_cog_scgt)
icm_cog_scgt[,1:4873] <- sapply(icm_cog_scgt[, c(1:4873)], as.integer)

cog_ss <- rrarefy(icm_cog_scgt, min(rowSums(icm_cog_scgt)))
cog_acc2.1 <- specaccum(cog_ss, method = "exact", permutations = 1000)
plot(cog_acc2.1)
```


## Accumulation curve COG MGN


### Whole

```{r}
cog_acc2 <- specaccum(icm_cog_mgnt, method = "exact", permutations = 1000)
plot(cog_acc2)
```


### Subsampled


```{r}
icm_cog_mgnt <- as.data.frame(icm_cog_mgnt)
icm_cog_mgnt[,1:4873] <- sapply(icm_cog_mgnt[, c(1:4873)], as.integer)

cog_ss <- rrarefy(icm_cog_mgnt, min(rowSums(icm_cog_mgnt)))
cog_acc2.1 <- specaccum(cog_ss, method = "exact", permutations = 1000)
plot(cog_acc2.1)
```

## Accumulation curve PFAM SCG


### Whole

```{r}
pfam_acc1 <- specaccum(icm_pfam_scgt, method = "exact", permutations = 1000)
plot(pfam_acc1)
```


### Subsampled


```{r}
icm_pfam_scgt <- as.data.frame(icm_pfam_scgt)
icm_pfam_scgt[,1:16702] <- sapply(icm_pfam_scgt[, c(1:16702)], as.integer)

pfam_ss <- rrarefy(icm_pfam_scgt, min(rowSums(icm_pfam_scgt)))
pfam_acc2.1 <- specaccum(pfam_ss, method = "exact", permutations = 1000)
plot(pfam_acc2.1)
```


## Accumulation curve COG MGN


### Whole

```{r}
pfam_acc2 <- specaccum(icm_pfam_mgnt, method = "exact", permutations = 1000)
plot(pfam_acc2)
```


### Subsampled


```{r}
icm_pfam_mgnt <- as.data.frame(icm_pfam_mgnt)
icm_pfam_mgnt[,1:16702] <- sapply(icm_pfam_mgnt[, c(1:16702)], as.integer)

pfam_ss <- rrarefy(icm_pfam_mgnt, min(rowSums(icm_pfam_mgnt)))
pfam_acc2.1 <- specaccum(pfam_ss, method = "exact", permutations = 1000)
plot(pfam_acc2.1)
```








